openapi: 3.0.3
info:
  title: Bioly API
  version: 1.0.0
  description: API схемы для бизнес-логики приложения Bioly

servers:
  - url: https://api.bioly.me/v1
    description: Production server

paths:
  # Авторизация и регистрация
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Шаг 1 - Ввод email (общий для входа и регистрации)
      description: |
        Принимает email и определяет следующие шаги:
        - Если пользователь существует и у него есть пароль: возвращает next_step = "password"
        - Если пользователь существует, но пароля нет: отправляет OTP и возвращает next_step = "otp"
        - Если пользователь не существует: отправляет OTP и возвращает next_step = "signup_slug"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Информация о следующих шагах
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginInitResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/login/password:
    post:
      tags:
        - Authentication
      summary: Шаг 2 - Вход по паролю (опционально)
      description: |
        Выполняет вход пользователя по паролю.
        Используется только если у пользователя установлен пароль (has_password = true).
        При успешной верификации возвращает access token.
        Refresh token устанавливается в HTTP-only cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginPasswordRequest"
      responses:
        "200":
          description: Успешный вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/WrongPassword"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/login/otp:
    post:
      tags:
        - Authentication
      summary: Шаг 2 - Вход по OTP коду
      description: |
        Проверяет OTP код и выполняет вход пользователя в систему.
        Используется если у пользователя нет пароля или он выбрал вход по OTP.
        При успешной верификации возвращает access token.
        Refresh token устанавливается в HTTP-only cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginVerifyOtpRequest"
      responses:
        "200":
          description: Успешный вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Регистрация
  /auth/signup/slug:
    post:
      tags:
        - Authentication
      summary: Шаг 2 - Ввод slug для регистрации
      description: |
        Проверяет доступность slug и сохраняет его для процесса регистрации.
        Используется только если пользователь не существует (user_exists = false из /auth/login).
        После успешного запроса пользователь должен ввести OTP код на следующем шаге.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignupEnterSlugRequest"
      responses:
        "200":
          description: Slug доступен и сохранен
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                properties:
                  success:
                    type: boolean
                    example: true
        "400":
          $ref: "#/components/responses/InvalidSlugFormat"
        "409":
          $ref: "#/components/responses/SlugAlreadyTaken"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/signup/verify:
    post:
      tags:
        - Authentication
      summary: Шаг 3 - Верификация OTP и завершение регистрации
      description: |
        Проверяет OTP код и завершает регистрацию нового пользователя.
        Используется только для регистрации (после ввода slug).
        При успешной верификации создается новый профиль и возвращается access token.
        Refresh token устанавливается в HTTP-only cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignupVerifyOtpRequest"
      responses:
        "200":
          description: Успешная регистрация
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SignupResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "409":
          $ref: "#/components/responses/EmailAlreadyExists"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Смена пароля
  /auth/password/change:
    post:
      tags:
        - Authentication
      summary: Шаг 1 - Запрос на смену пароля
      description: |
        Отправляет код подтверждения на email пользователя для смены пароля.
        Требует аутентификации. После успешного запроса пользователь должен ввести OTP код на следующем шаге.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "200":
          description: Код подтверждения успешно отправлен на email
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SendOtpResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/password/change/verify:
    post:
      tags:
        - Authentication
      summary: Шаг 2 - Верификация OTP и смена пароля
      description: |
        Проверяет OTP код и изменяет пароль пользователя.
        Требует аутентификации.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordVerifyOtpRequest"
      responses:
        "200":
          description: Пароль успешно изменен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChangePasswordResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Добавление пароля
  /auth/password/add:
    post:
      tags:
        - Authentication
      summary: Шаг 1 - Запрос на добавление пароля
      description: |
        Отправляет код подтверждения на email пользователя для добавления пароля к аккаунту.
        Требует аутентификации. После успешного запроса пользователь должен ввести OTP код на следующем шаге.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddPasswordRequest"
      responses:
        "200":
          description: Код подтверждения успешно отправлен на email
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SendOtpResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/password/add/verify:
    post:
      tags:
        - Authentication
      summary: Шаг 2 - Верификация OTP и добавление пароля
      description: |
        Проверяет OTP код и добавляет пароль к аккаунту пользователя.
        Требует аутентификации.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddPasswordVerifyOtpRequest"
      responses:
        "200":
          description: Пароль успешно добавлен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddPasswordResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Смена email
  /auth/email/change:
    post:
      tags:
        - Authentication
      summary: Шаг 1 - Запрос на смену email
      description: |
        Отправляет код подтверждения на новый email адрес для смены email пользователя.
        Требует аутентификации (bearer token подтверждает владение аккаунтом).
        Уведомление о попытке смены email отправляется на текущий (старый) email адрес.
        После успешного запроса пользователь должен ввести OTP код на следующем шаге.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangeEmailRequest"
      responses:
        "200":
          description: Код подтверждения успешно отправлен на новый email. Уведомление отправлено на старый email.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SendOtpResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/EmailAlreadyExists"
        "429":
          $ref: "#/components/responses/RateLimitExceeded"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/email/change/verify:
    post:
      tags:
        - Authentication
      summary: Шаг 2 - Верификация OTP и смена email
      description: |
        Проверяет OTP код, отправленный на новый email, и изменяет email пользователя.
        Требует аутентификации. После успешной смены email пользователь должен будет использовать новый email для входа.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangeEmailVerifyOtpRequest"
      responses:
        "200":
          description: Email успешно изменен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChangeEmailResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/InvalidOtp"
        "404":
          $ref: "#/components/responses/UserNotFound"
        "409":
          $ref: "#/components/responses/EmailAlreadyExists"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Смена slug
  /auth/slug/check:
    get:
      tags:
        - Authentication
      summary: Проверка доступности slug
      description: |
        Проверяет доступность slug для использования.
        Можно использовать без аутентификации для проверки перед регистрацией.
      parameters:
        - name: slug
          in: query
          required: true
          schema:
            type: string
            minLength: 3
            maxLength: 30
            pattern: "^[a-z0-9_-]+$"
          description: URL-слаг для проверки доступности
          example: username
      responses:
        "200":
          description: Результат проверки доступности
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckSlugAvailabilityResponse"
        "400":
          $ref: "#/components/responses/InvalidSlugFormat"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/slug/change:
    post:
      tags:
        - Authentication
      summary: Смена slug профиля
      description: |
        Изменяет slug профиля пользователя.
        Требует аутентификации. Можно изменить только раз в 7 дней.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangeSlugRequest"
      responses:
        "200":
          description: Slug успешно изменен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChangeSlugResponse"
        "400":
          $ref: "#/components/responses/InvalidSlugFormat"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/SlugChangeLimitExceeded"
        "409":
          $ref: "#/components/responses/SlugAlreadyTaken"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Обновление токена
  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Обновление access token
      description: |
        Обновляет access token используя refresh token из HTTP-only cookie.
        Новый refresh token устанавливается в HTTP-only cookie.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
      responses:
        "200":
          description: Токен успешно обновлен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshTokenResponse"
        "401":
          $ref: "#/components/responses/InvalidRefreshToken"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Выход из системы
  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Выход из системы
      description: |
        Инвалидирует refresh token из HTTP-only cookie и все связанные токены пользователя.
        Требует аутентификации через refresh token в cookie.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogoutRequest"
      responses:
        "200":
          description: Успешный выход из системы
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutResponse"
        "401":
          $ref: "#/components/responses/InvalidRefreshToken"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  schemas:
    # Profile schemas
    Profile:
      type: object
      required:
        - id
        - name
        - slug
        - email
        - created_at
        - protected_by_password
        - short_description
        - theme
        - social_media
        - bento
      properties:
        id:
          type: string
          description: Уникальный идентификатор профиля (UUID или другой уникальный идентификатор)
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 1
          maxLength: 255
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: Имя профиля
          minLength: 0
          maxLength: 100
          example: "John Doe"
        slug:
          type: string
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
          description: |
            URL-слаг профиля. Должен содержать только строчные латинские буквы,
            цифры, дефисы и подчеркивания. Не может начинаться или заканчиваться
            на дефис или подчеркивание. Должен быть уникальным.
          example: "johndoe"
        email:
          type: string
          format: email
          description: Email пользователя
          minLength: 1
          maxLength: 255
          example: "user@example.com"
        created_at:
          type: string
          format: date-time
          description: Дата создания профиля
        avatar_url:
          type: string
          format: uri
          nullable: true
          description: URL аватара профиля. Должен быть валидным HTTP/HTTPS URL.
          maxLength: 2048
          example: "https://example.com/avatar.jpg"
        protected_by_password:
          type: boolean
          description: Защищен ли профиль паролем
        short_description:
          type: string
          description: Краткое описание профиля
          minLength: 0
          maxLength: 200
          example: "Software developer and designer"
        description:
          nullable: true
          allOf:
            - $ref: "#/components/schemas/JSONContent"
          description: Полное описание профиля в формате TipTap JSON. Может быть null или JSONContent.
        theme:
          $ref: "#/components/schemas/ProfileTheme"
        social_media:
          type: array
          items:
            $ref: "#/components/schemas/SocialMediaItem"
          maxItems: 20
          uniqueItems: true
          description: |
            Массив социальных сетей. Максимум 20 элементов.
            Порядок (order) должен быть уникальным для каждого элемента.
        bento:
          type: array
          items:
            $ref: "#/components/schemas/BentoBlock"
          maxItems: 50
          uniqueItems: true
          description: |
            Массив блоков Bento. Максимум 50 элементов.
            ID и порядок (order) должны быть уникальными для каждого блока.

    ProfileMainEditableFields:
      type: object
      required:
        - name
        - slug
        - email
        - created_at
        - protected_by_password
        - short_description
        - theme
        - social_media
        - bento
      properties:
        name:
          type: string
          minLength: 0
          maxLength: 100
        slug:
          type: string
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
        email:
          type: string
          format: email
          minLength: 1
          maxLength: 255
        created_at:
          type: string
          format: date-time
        avatar_url:
          type: string
          format: uri
          nullable: true
          maxLength: 2048
        protected_by_password:
          type: boolean
        short_description:
          type: string
          minLength: 0
          maxLength: 200
        description:
          nullable: true
          allOf:
            - $ref: "#/components/schemas/JSONContent"
          description: Полное описание профиля в формате TipTap JSON. Может быть null или JSONContent.
        theme:
          $ref: "#/components/schemas/ProfileTheme"
        social_media:
          type: array
          items:
            $ref: "#/components/schemas/SocialMediaItem"
          maxItems: 20
          uniqueItems: true
        bento:
          type: array
          items:
            $ref: "#/components/schemas/BentoBlock"
          maxItems: 50
          uniqueItems: true

    ProfileTheme:
      type: object
      required:
        - font
        - theme
        - show_avatar_blur
        - border_radius
        - border_width
      properties:
        font:
          $ref: "#/components/schemas/Font"
        theme:
          $ref: "#/components/schemas/Theme"
        show_avatar_blur:
          type: boolean
          description: Показывать ли размытие аватара
        border_radius:
          type: number
          minimum: 0
          maximum: 42
          description: Радиус скругления границ в пикселях
          example: 24
        border_width:
          type: number
          minimum: 1
          maximum: 6
          description: Ширина границы в пикселях
          example: 1

    Font:
      type: string
      enum:
        - open-runde
        - inter
        - gilroy
        - vollkorn
        - jetbrains-mono
        - montserrat
        - oswald
        - caveat
      description: Доступные шрифты

    Theme:
      type: string
      enum:
        - light
        - dark
        - green
        - pink
        - blue
        - purple
        - golden
        - dark-blue
        - dark-slate
        - dark-forest
        - dark-plum
        - dark-amber
        - dark-ink
        - dark-copper
        - dark-olive
        - dark-indigo
        - teal
        - coral
        - lavender
        - sand
        - mint
        - sky
        - ice
        - peach
      description: Доступные темы оформления

    # Social Media schemas
    SocialMediaItem:
      type: object
      required:
        - platform
        - slug
        - order
      properties:
        platform:
          $ref: "#/components/schemas/SocialMediaPlatform"
        slug:
          type: string
          description: Идентификатор пользователя на платформе
          minLength: 1
          maxLength: 100
          example: "johndoe"
        order:
          type: integer
          minimum: 0
          description: Порядок отображения. Должен быть уникальным в массиве social_media.
          example: 0

    SocialMediaPlatform:
      type: string
      enum:
        - instagram
        - telegram
        - x
        - bluesky
        - discord
        - dribbble
        - facebook
        - github
        - linkedin
        - tiktok
        - threads
        - pinterest
        - medium
        - youtube
        - messenger
        - reddit
        - snapchat
        - spotify
        - tumblr
        - twitch
        - vk
        - whatsapp
      description: Доступные платформы социальных сетей

    # Bento Block schemas
    BentoBlock:
      oneOf:
        - $ref: "#/components/schemas/BentoBlockGallery"
        - $ref: "#/components/schemas/BentoBlockLink"
        - $ref: "#/components/schemas/BentoBlockText"
        - $ref: "#/components/schemas/BentoBlockMap"
      discriminator:
        propertyName: type
        mapping:
          gallery: "#/components/schemas/BentoBlockGallery"
          link: "#/components/schemas/BentoBlockLink"
          text: "#/components/schemas/BentoBlockText"
          map: "#/components/schemas/BentoBlockMap"

    BentoBlockBase:
      type: object
      required:
        - id
        - size
        - order
        - style
        - type
        - properties
      properties:
        id:
          type: string
          description: Уникальный идентификатор блока. Должен быть уникальным в массиве bento.
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 1
          maxLength: 255
        size:
          $ref: "#/components/schemas/BentoBlockSize"
        order:
          type: integer
          minimum: 0
          description: Порядок отображения блока. Должен быть уникальным в массиве bento.
          example: 0
        style:
          $ref: "#/components/schemas/BentoBlockStyle"
        type:
          $ref: "#/components/schemas/BentoBlockType"

    BentoBlockGallery:
      allOf:
        - $ref: "#/components/schemas/BentoBlockBase"
        - type: object
          properties:
            type:
              type: string
              enum: [gallery]
            properties:
              $ref: "#/components/schemas/BentoBlockPropertiesGallery"

    BentoBlockLink:
      allOf:
        - $ref: "#/components/schemas/BentoBlockBase"
        - type: object
          properties:
            type:
              type: string
              enum: [link]
            properties:
              $ref: "#/components/schemas/BentoBlockPropertiesLink"

    BentoBlockText:
      allOf:
        - $ref: "#/components/schemas/BentoBlockBase"
        - type: object
          properties:
            type:
              type: string
              enum: [text]
            properties:
              $ref: "#/components/schemas/BentoBlockPropertiesText"

    BentoBlockMap:
      allOf:
        - $ref: "#/components/schemas/BentoBlockBase"
        - type: object
          properties:
            type:
              type: string
              enum: [map]
            properties:
              $ref: "#/components/schemas/BentoBlockPropertiesMap"

    BentoBlockSize:
      type: string
      enum:
        - "2x2"
        - "4x1"
        - "2x4"
        - "4x2"
        - "4x4"
        - dynamic
      description: Размер блока Bento

    BentoBlockStyle:
      type: string
      enum:
        - plain
        - shadow
        - outline
        - transparent
      description: Стиль блока Bento

    BentoBlockType:
      type: string
      enum:
        - gallery
        - link
        - text
        - map
      description: Тип блока Bento

    BentoBlockPropertiesGallery:
      type: object
      required:
        - media
      properties:
        media:
          type: array
          items:
            type: string
            format: uri
            maxLength: 2048
          description: Массив URL изображений для галереи
          minItems: 1
          maxItems: 10
          uniqueItems: true
          example:
            - "https://example.com/image1.jpg"
            - "https://example.com/image2.jpg"

    BentoBlockPropertiesLink:
      type: object
      required:
        - url
        - title
        - url_valid
      properties:
        url:
          type: string
          format: uri
          description: URL ссылки. Должен быть валидным HTTP/HTTPS URL.
          maxLength: 2048
          example: "https://example.com"
        title:
          type: string
          description: Заголовок ссылки
          minLength: 0
          maxLength: 200
          example: "My Website"
        url_valid:
          type: boolean
          description: Валидна ли ссылка (проверяется на сервере)

    BentoBlockPropertiesText:
      type: object
      required:
        - content
      properties:
        content:
          nullable: true
          allOf:
            - $ref: "#/components/schemas/JSONContent"
          description: |
            Содержимое текстового блока в формате TipTap JSON.
            Максимальный размер JSON: 50KB (50,000 символов в сериализованном виде).

    BentoBlockPropertiesMap:
      type: object
      required:
        - theme
        - labels
        - interactions
        - zoom
        - title
        - titleAlign
        - latitude
        - longitude
      properties:
        theme:
          $ref: "#/components/schemas/BentoBlockMapThemesOptions"
        labels:
          type: boolean
          description: Показывать ли подписи на карте
        interactions:
          type: boolean
          description: Разрешены ли взаимодействия с картой (зум, перетаскивание)
        zoom:
          type: number
          minimum: 0
          maximum: 22
          default: 11
          description: Уровень масштабирования карты (0 - минимальный, 22 - максимальный)
          example: 11
        title:
          type: string
          description: Заголовок карты
          minLength: 0
          maxLength: 200
          example: "My Location"
        titleAlign:
          $ref: "#/components/schemas/BentoBlockMapTitleAlign"
        latitude:
          type: number
          format: float
          minimum: -90
          maximum: 90
          description: Широта центра карты в градусах (WGS84)
          example: 55.7558
        longitude:
          type: number
          format: float
          minimum: -180
          maximum: 180
          description: Долгота центра карты в градусах (WGS84)
          example: 37.6173

    BentoBlockMapThemesOptions:
      type: string
      enum:
        - auto
        - light
        - dark
        - positron
      description: Тема карты (auto означает автоматический выбор на основе темы профиля)

    BentoBlockMapTitleAlign:
      type: string
      enum:
        - bottom-left
        - bottom-center
        - bottom-right
        - top-left
        - top-center
        - top-right
      description: Выравнивание заголовка карты

    # TipTap JSON Content schema
    JSONContent:
      type: object
      x-tags:
        - Profile
        - Bento
      description: |
        Структурированный JSON контент из TipTap редактора.
        Максимальный размер JSON: 50KB (50,000 символов в сериализованном виде).
      properties:
        type:
          type: string
          description: Тип узла (doc, paragraph, heading, text и т.д.)
        attrs:
          type: object
          additionalProperties: true
          description: Атрибуты узла. Могут содержать любые JSON-сериализуемые значения.
        content:
          type: array
          items:
            $ref: "#/components/schemas/JSONContent"
          description: Дочерние узлы. Узел может содержать другие узлы.
        marks:
          type: array
          items:
            $ref: "#/components/schemas/JSONContentMark"
          description: Список марок узла. Инлайн-узлы могут иметь марки.
        text:
          type: string
          description: |
            Текстовое содержимое узла. Это свойство присутствует только у текстовых узлов
            (т.е. узлов с type: 'text'). Текстовые узлы не могут иметь дочерних узлов,
            но могут иметь марки.
      additionalProperties: true

    JSONContentMark:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          description: Тип марки (bold, italic, link и т.д.)
        attrs:
          type: object
          additionalProperties: true
          description: Атрибуты марки. Могут содержать любые JSON-сериализуемые значения.
      additionalProperties: true

    # Authentication schemas
    LoginRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email пользователя для входа
          example: user@example.com

    LoginVerifyOtpRequest:
      type: object
      required:
        - email
        - otp
      properties:
        email:
          type: string
          format: email
          description: Email пользователя
          example: user@example.com
        otp:
          type: string
          pattern: "^[0-9]{6}$"
          description: Код подтверждения из 6 цифр
          example: "123456"

    LoginResponse:
      type: object
      required:
        - access_token
      properties:
        access_token:
          type: string
          description: JWT токен доступа
      description: |
        Refresh token устанавливается в HTTP-only cookie с именем `refresh_token`.
        Cookie имеет флаги HttpOnly, Secure и SameSite=Strict для безопасности.

    LoginInitResponse:
      type: object
      required:
        - user_exists
        - next_step
      properties:
        user_exists:
          type: boolean
          description: Существует ли пользователь с таким email
          example: true
        has_password:
          type: boolean
          description: Есть ли у пользователя пароль (только если user_exists = true)
          example: true
        next_step:
          type: string
          enum:
            - password
            - otp
            - signup_slug
          description: |
            Следующий шаг для пользователя:
            - password - ввод пароля (если user_exists = true и has_password = true)
            - otp - ввод OTP кода (если user_exists = true и has_password = false)
            - signup_slug - ввод slug для регистрации (если user_exists = false)
          example: "password"
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Время истечения OTP кода (если отправлен OTP)
          example: "2024-01-01T12:00:00Z"

    LoginPasswordRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: Email пользователя
          example: user@example.com
        password:
          type: string
          minLength: 1
          description: Пароль пользователя
          example: "MyPassword123"

    SignupRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email пользователя для регистрации
          example: user@example.com

    SignupEnterSlugRequest:
      type: object
      required:
        - email
        - slug
      properties:
        email:
          type: string
          format: email
          description: Email пользователя
          example: user@example.com
        slug:
          type: string
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
          description: |
            URL-слаг профиля. Должен содержать только строчные латинские буквы,
            цифры, дефисы и подчеркивания. Не может начинаться или заканчиваться
            на дефис или подчеркивание.
          example: username

    SignupVerifyOtpRequest:
      type: object
      required:
        - email
        - slug
        - otp
      properties:
        email:
          type: string
          format: email
          description: Email пользователя
          example: user@example.com
        slug:
          type: string
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
          description: URL-слаг профиля
          example: username
        otp:
          type: string
          pattern: "^[0-9]{6}$"
          description: Код подтверждения из 6 цифр
          example: "123456"

    SignupResponse:
      type: object
      required:
        - access_token
      properties:
        access_token:
          type: string
          description: JWT токен доступа
      description: |
        Refresh token устанавливается в HTTP-only cookie с именем `refresh_token`.
        Cookie имеет флаги HttpOnly, Secure и SameSite=Strict для безопасности.

    SendOtpRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email для отправки кода подтверждения
          example: user@example.com

    SendOtpResponse:
      type: object
      required:
        - success
        - expires_at
      properties:
        success:
          type: boolean
          description: Успешно ли отправлен код
        expires_at:
          type: string
          format: date-time
          description: Время истечения кода подтверждения

    ChangePasswordRequest:
      type: object
      required:
        - old_password
        - new_password
        - confirm_password
      properties:
        old_password:
          type: string
          minLength: 1
          description: Текущий пароль пользователя
        new_password:
          type: string
          minLength: 8
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).+$"
          description: |
            Новый пароль. Должен содержать минимум 8 символов,
            минимум одну заглавную букву, одну строчную букву и одну цифру.
            Новый пароль должен отличаться от старого пароля.
        confirm_password:
          type: string
          minLength: 1
          description: Подтверждение нового пароля (должно совпадать с new_password)

    ChangePasswordVerifyOtpRequest:
      type: object
      required:
        - email
        - otp
        - new_password
      properties:
        email:
          type: string
          format: email
          description: Email пользователя
          example: user@example.com
        otp:
          type: string
          pattern: "^[0-9]{6}$"
          description: Код подтверждения из 6 цифр
          example: "123456"
        new_password:
          type: string
          minLength: 8
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).+$"
          description: Новый пароль

    ChangePasswordResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Успешно ли изменен пароль

    AddPasswordRequest:
      type: object
      required:
        - new_password
        - confirm_password
      properties:
        new_password:
          type: string
          minLength: 8
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).+$"
          description: |
            Новый пароль. Должен содержать минимум 8 символов,
            минимум одну заглавную букву, одну строчную букву и одну цифру.
        confirm_password:
          type: string
          minLength: 1
          description: Подтверждение нового пароля (должно совпадать с new_password)

    AddPasswordVerifyOtpRequest:
      type: object
      required:
        - email
        - otp
        - new_password
      properties:
        email:
          type: string
          format: email
          description: Email пользователя
          example: user@example.com
        otp:
          type: string
          pattern: "^[0-9]{6}$"
          description: Код подтверждения из 6 цифр
          example: "123456"
        new_password:
          type: string
          minLength: 8
          pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).+$"
          description: Новый пароль

    AddPasswordResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Успешно ли добавлен пароль

    # Change Email schemas
    ChangeEmailRequest:
      type: object
      required:
        - new_email
      properties:
        new_email:
          type: string
          format: email
          description: Новый email адрес
          example: newemail@example.com

    ChangeEmailVerifyOtpRequest:
      type: object
      required:
        - new_email
        - otp
      properties:
        new_email:
          type: string
          format: email
          description: Новый email адрес
          example: newemail@example.com
        otp:
          type: string
          pattern: "^[0-9]{6}$"
          description: Код подтверждения из 6 цифр, отправленный на новый email
          example: "123456"

    ChangeEmailResponse:
      type: object
      required:
        - success
        - email
      properties:
        success:
          type: boolean
          description: Успешно ли изменен email
        email:
          type: string
          format: email
          description: Новый email адрес
          example: newemail@example.com

    # Change Slug schemas
    ChangeSlugRequest:
      type: object
      required:
        - slug
      properties:
        slug:
          type: string
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
          description: |
            Новый URL-слаг профиля. Должен содержать только строчные латинские буквы,
            цифры, дефисы и подчеркивания. Не может начинаться или заканчиваться
            на дефис или подчеркивание. Можно изменить только раз в 7 дней.
          example: newusername

    ChangeSlugResponse:
      type: object
      required:
        - success
        - slug
      properties:
        success:
          type: boolean
          description: Успешно ли изменен slug
        slug:
          type: string
          description: Новый slug профиля
          example: newusername

    CheckSlugAvailabilityRequest:
      type: object
      required:
        - slug
      properties:
        slug:
          type: string
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
          description: URL-слаг для проверки доступности
          example: username

    CheckSlugAvailabilityResponse:
      type: object
      required:
        - available
      properties:
        available:
          type: boolean
          description: Доступен ли slug для использования
        message:
          type: string
          nullable: true
          description: Сообщение о причине недоступности (если available = false)
          example: "This username is already taken"

    # Public Profile schema
    PublicProfile:
      type: object
      required:
        - id
        - name
        - slug
        - avatar_url
        - short_description
        - description
        - theme
        - social_media
        - bento
      properties:
        id:
          type: string
          description: Уникальный идентификатор профиля
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 1
          maxLength: 255
        name:
          type: string
          description: Имя профиля
          minLength: 0
          maxLength: 100
        slug:
          type: string
          description: URL-слаг профиля
          minLength: 3
          maxLength: 30
          pattern: "^[a-z0-9_-]+$"
        avatar_url:
          type: string
          format: uri
          nullable: true
          description: URL аватара профиля
          maxLength: 2048
        short_description:
          type: string
          description: Краткое описание профиля
          minLength: 0
          maxLength: 200
        description:
          nullable: true
          allOf:
            - $ref: "#/components/schemas/JSONContent"
          description: Полное описание профиля в формате TipTap JSON. Может быть null или JSONContent.
        theme:
          $ref: "#/components/schemas/ProfileTheme"
        social_media:
          type: array
          items:
            $ref: "#/components/schemas/SocialMediaItem"
          maxItems: 20
          uniqueItems: true
          description: |
            Массив социальных сетей. Максимум 20 элементов.
            Порядок (order) должен быть уникальным для каждого элемента.
        bento:
          type: array
          items:
            $ref: "#/components/schemas/BentoBlock"
          maxItems: 50
          uniqueItems: true
          description: |
            Массив блоков Bento. Максимум 50 элементов.
            ID и порядок (order) должны быть уникальными для каждого блока.

    GetProfileBySlugRequest:
      type: object
      required:
        - slug
      properties:
        slug:
          type: string
          description: URL-слаг профиля для получения публичных данных
          example: username

    GetProfileBySlugResponse:
      $ref: "#/components/schemas/PublicProfile"

    # Refresh Token schemas
    RefreshTokenRequest:
      type: object
      description: |
        Refresh token должен быть передан в HTTP-only cookie с именем `refresh_token`.
        Тело запроса может быть пустым, так как токен читается из cookie.
      properties: {}

    RefreshTokenResponse:
      type: object
      required:
        - access_token
      properties:
        access_token:
          type: string
          description: Новый JWT токен доступа
      description: |
        Новый refresh token устанавливается в HTTP-only cookie с именем `refresh_token`.
        Cookie имеет флаги HttpOnly, Secure и SameSite=Strict для безопасности.

    # Logout schemas
    LogoutRequest:
      type: object
      description: |
        Refresh token для инвалидации читается из HTTP-only cookie с именем `refresh_token`.
        Тело запроса может быть пустым, так как токен читается из cookie.
        Сервер инвалидирует refresh token из cookie и все связанные токены пользователя.
      properties: {}

    LogoutResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Успешно ли выполнен выход из системы
        message:
          type: string
          nullable: true
          description: Сообщение о результате операции
          example: "Successfully logged out"

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Код ошибки
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Сообщение об ошибке
          example: "Invalid email address"
        details:
          type: object
          additionalProperties: true
          description: Дополнительные детали ошибки

  responses:
    ValidationError:
      description: Ошибка валидации
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    InvalidEmail:
      description: Неверный формат email
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "VALIDATION_ERROR"
            message: "Invalid email format"

    InvalidOtpFormat:
      description: Неверный формат OTP
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "VALIDATION_ERROR"
            message: "OTP must be 6 digits"

    InvalidOtp:
      description: Неверный или истекший OTP код
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalid_otp:
              value:
                error: "INVALID_OTP"
                message: "Invalid or expired OTP code"
            otp_expired:
              value:
                error: "OTP_EXPIRED"
                message: "OTP code has expired"

    InvalidSlugFormat:
      description: Неверный формат slug
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalid_format:
              value:
                error: "VALIDATION_ERROR"
                message: "Slug must be 3-30 characters, lowercase letters, numbers, dashes and underscores only"
            too_short:
              value:
                error: "VALIDATION_ERROR"
                message: "Slug must be at least 3 characters"
            too_long:
              value:
                error: "VALIDATION_ERROR"
                message: "Slug must be at most 30 characters"
            starts_with_dash:
              value:
                error: "VALIDATION_ERROR"
                message: "Slug cannot start or end with dash or underscore"

    InvalidPasswordFormat:
      description: Неверный формат пароля
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "VALIDATION_ERROR"
            message: "Password must be at least 8 characters with uppercase, lowercase and number"

    Unauthorized:
      description: Не авторизован
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "UNAUTHORIZED"
            message: "Authentication required"

    UserNotFound:
      description: Пользователь не найден
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "USER_NOT_FOUND"
            message: "User with this email does not exist"

    EmailAlreadyExists:
      description: Email уже занят
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "EMAIL_ALREADY_EXISTS"
            message: "User with this email already exists"

    SlugAlreadyTaken:
      description: Slug уже занят
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "SLUG_ALREADY_TAKEN"
            message: "This username is already taken"

    RateLimitExceeded:
      description: Слишком много запросов
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "RATE_LIMIT_EXCEEDED"
            message: "Too many requests. Please try again later."

    InternalServerError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    WrongPassword:
      description: Неверный пароль
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "WRONG_PASSWORD"
            message: "Current password is incorrect"

    SamePassword:
      description: Новый пароль совпадает со старым
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "SAME_PASSWORD"
            message: "New password must be different from old password"

    PasswordsDoNotMatch:
      description: Пароли не совпадают
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "VALIDATION_ERROR"
            message: "New password and confirmation do not match"

    PasswordAlreadyExists:
      description: Пароль уже установлен
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "PASSWORD_ALREADY_EXISTS"
            message: "Account already has a password"

    SameEmail:
      description: Новый email совпадает со старым
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "SAME_EMAIL"
            message: "New email must be different from current email"

    SameSlug:
      description: Новый slug совпадает со старым
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "SAME_SLUG"
            message: "New slug must be different from current slug"

    SlugChangeLimitExceeded:
      description: Превышен лимит смены slug
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "SLUG_CHANGE_LIMIT_EXCEEDED"
            message: "Slug can be changed only once per 7 days"

    InvalidRefreshToken:
      description: Неверный или истекший refresh token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalid_token:
              value:
                error: "INVALID_REFRESH_TOKEN"
                message: "Invalid or expired refresh token"
            token_not_found:
              value:
                error: "REFRESH_TOKEN_NOT_FOUND"
                message: "Refresh token not found in cookies"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT токен доступа передается в заголовке Authorization в формате:
        `Authorization: Bearer <token>`
